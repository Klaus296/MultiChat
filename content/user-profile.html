<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io({ auth: { token: localStorage.getItem("token") } });
  const userFriends = [];
  const mainRooms = [];
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      return parts.pop().split(";").shift();
    }
    return null;
  }
  document.addEventListener("DOMContentLoaded", () => {
  // socket.emit("check admin");
  socket.on("is admin",()=>{
    document.getElementById("support").style.display="inline-block";
    document.getElementById("support").onclick=null;
    document.getElementById("support").href="/messages";
    
  })
  document.getElementById("change-language").addEventListener("click",()=>{
    console.log("Pay");
    const language = document.getElementById("language").value.trim();
    console.log(language);
    socket.emit("change language",(language));
  });

  socket.emit("get user name");
  socket.emit("show rooms");
  socket.emit("show saved rooms");
  socket.on("set name", (name) => {
    document.getElementById("user-name").textContent = document.cookie;
  });
  socket.on("name changed",(name)=>{
    document.getElementById("user-name").textContent = name;
    alert("Name changed to "+name);
  });
  socket.on("username",(username)=>{
    const name = username;
    if (!name){
      window.location.href="/";
      return;
    }
  })

  // ‚¨áÔ∏è —Ç–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∞ —Ç–æ—á–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  socket.on("user del",()=>{
    window.location.href="/";
  })
  function toChat(friend){
    socket.emit("get hash",friend);
    socket.on("set hash",(hash)=>{
      console.log(hash);    
      window.location.href = `/your?room=${encodeURIComponent(hash)}`;          
  })
    
  }
});


socket.on("room edited", ({ room, newDescription }) => {
  alert(`–ö–æ–º–Ω–∞—Ç–∞ "${room}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!`);
  window.location.reload();
  // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏—Ç—å DOM –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
  const card = [...document.querySelectorAll("#rooms-list div")]
    .find(div => div.querySelector("h3")?.textContent === room);
  if (card) {
    card.querySelector("p").textContent = newDescription;
  }
});

socket.on("room edit error", (err) => {
  alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: " + err);
});

socket.on("rooms", (rooms) => {
  console.log(" –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã:", rooms);
  const roomsContainer = document.querySelector("#rooms-list");
  roomsContainer.innerHTML = "";
  
  if (!rooms || rooms.length === 0) {
    roomsContainer.innerHTML = `<p class="text-gray-500">No rooms yet</p>`;
    return;
  }
  
  rooms.forEach(room => {
    const backgrounds = ["study.jpg", "social.jpg"]
    const randomIndex = Math.floor(Math.random() * backgrounds.length);
    const roomCard = document.createElement("div");
    roomCard.className =
      "p-4 bg-indigo-100 rounded-lg shadow hover:bg-indigo-200 transition";
    roomCard.style.backgroundImage = "url('/content/images/" + backgrounds[randomIndex] + "')";
    roomCard.style.backgroundSize = "cover";
    roomCard.style.backgroundPosition = "center";
    roomCard.innerHTML = `
      <h3 style="background-color:#2596be;" class="font-semibold">${room.room_name}</h3>
      <p style="background-color:#2596be; opacity:0.9; color:gold;">Description: ${room.description}</p>
      <button id="join-room" class="text-red-500 bg-gray-500 px-2 py-1 rounded hover:bg-gray-300" >Join</button>
      <button id="del-room" class="text-red-500 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300" >Delete</button>
      <button id="edit-room" class="text-red-500 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">Edit</button>  

    `;
    roomCard.querySelector("#del-room").onclick = ()=>{deleteRoom(room.room_name)};
    roomCard.querySelector("#join-room").onclick = ()=>{toRoomChat(room.room_name)};
    roomCard.querySelector("#edit-room").onclick = ()=>{roomCard.innerHTML = `<h3 class="font-semibold">${room.room_name}</h3>
    <input type="text" id="new-desc" class="w-full p-2 border rounded mb-4" placeholder="New description" value="${room.description}">
    <button id="save-edit" class="text-red-500 bg-gray-500 px-2 py-1 rounded hover:bg-gray-300">Save</button>`
    roomCard.querySelector("#save-edit").onclick = ()=>{
      const newDesc = document.getElementById("new-desc").value.trim();
      if (newDesc.length > 200) {
        alert("Description too long (max 200 characters)");
        return;
      }
      socket.emit("edit room", { room: room.room_name, newDescription: newDesc });
    }
    };
    socket.on("room deleted", (room)=>{
      alert(`${room} delete! Restart the page`)
    });
    roomsContainer.appendChild(roomCard);
    // document.getElementById("join-room").onclick = ()=>{window.location.href = `/main?room=${encodeURIComponent(room.room_name)}`;};
    // document.getElementById("del-room").onclick = ()=>{console.log(room);socket.emit("del room",room.room_name)};
  });
});
socket.on("saved rooms", (rooms) => {
  console.log("üî• –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã:", rooms);

  const roomsContainer = document.querySelector("#main-rooms-list");
  roomsContainer.innerHTML = "";
  
  if (!rooms || rooms.length === 0) {
    roomsContainer.innerHTML = `<p class="text-gray-500">No saved rooms yet</p>`;
    return;
  }
  
  rooms.forEach(room => {
    const backgrounds = ["study.jpg", "social.jpg"]
    const randomIndex = Math.floor(Math.random() * backgrounds.length);
    const roomCard = document.createElement("div");
    roomCard.className =
      "p-4 bg-indigo-100 rounded-lg shadow hover:bg-indigo-200 transition";
    roomCard.style.backgroundImage = "url('/content/images/" + backgrounds[randomIndex] + "')";
    roomCard.style.backgroundSize = "cover";
    roomCard.style.backgroundPosition = "center";
    roomCard.innerHTML = `
      <h3 style="background-color:#2596be;"   class="font-semibold">${room.room}</h3>
      <p style="background-color:#2596be; opacity:0.9; color:gold;">Description: ${room.description}</p>
      <p style="background-color:#2596be; opacity:0.9; color:gold;">Language: ${room.language}</p>
      <p align="right" style="background-color:#2596be; opacity:0.9; color:#FF2900; font-size:1.2em;">Author: ${room.username}</p>
      <button id="join-room" class="text-red-500 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300" >Join</button>
      <button id="del-room" class="text-red-500 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300" >Delete</button>
    `;
    roomCard.querySelector("#del-room").onclick = ()=>{deleteRoom2(room.room)};
    roomCard.querySelector("#join-room").onclick = ()=>{toRoomChat(room.room)};
    socket.on("room deleted", (room)=>{
      alert(`${room} delete! Restart the page`)
    });
    roomsContainer.appendChild(roomCard);
    // document.getElementById("join-room").onclick = ()=>{window.location.href = `/main?room=${encodeURIComponent(room.room_name)}`;};
    // document.getElementById("del-room").onclick = ()=>{console.log(room.room);socket.emit("del room",room)};
  });
});
socket.on("room delete error",(err)=>{
  alert(err);
})

function toRoomChat(roomName){
  window.location.href = `/room-chat?room=${encodeURIComponent(roomName)}`;
}
function deleteRoom(roomName){
  socket.emit("del-room",roomName);
}
function deleteRoom2(roomName){
  socket.emit("del room",roomName);
}
function editRoom(roomName){
  socket.emit("edit room",roomName);
}

function toChat(){
  alert("Connecting to support service...");
  socket.emit("add friend", { name: "Support service" });
  socket.on("friend added", (name) => {
    alert(`‚úÖ ${name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`);
    socket.emit("get hash","Support service");
  });
  socket.on("set hash",(hash)=>{
    console.log(hash);    
    window.location.href = `/your?room=${encodeURIComponent(hash)}`;          
  }) 
}
</script>

  <style>
    /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    .tab-content {
      display: none;
    }
    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª—å—é (:target) */
    .tab-content:target {
      display: block;
    }
    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–∏ */
    #profile:not(:target) ~ .tab-content#profile {
      display: block;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
    .tab-link:not([href="#profile"]):not(:hover) {
      background-color: #e5e7eb; /* bg-gray-200 */
    }
    .tab-link[href="#profile"] {
      background-color: #4f46e5; /* bg-indigo-500 */
      color: white;
    }
    .tab-link:target, .tab-link[href="#profile"]:not(:target) ~ .tab-link[href="#profile"] {
      background-color: #4f46e5; /* bg-indigo-500 */
      color: white;
    }
    .tab-link:not(:target):hover {
      background-color: #d1d5db; /* bg-gray-300 */
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
    <!-- Profile Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 text-center sm:text-left">
      <a id="support" onclick="toChat()" class="inline-block px-5 py-2 rounded-lg bg-green-500 text-white font-semibold shadow hover:bg-indigo-600 transition mb-4 sm:mb-0 text-center">Support service</a>

      <h1 style="text-align: center;" id="user-name" class="text-2xl sm:text-3xl font-bold">User</h1>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex justify-center sm:justify-start gap-4 mb-6">
      <a href="#settings" class="tab-link px-4 py-2 rounded-lg font-medium text-gray-900">Settings</a>
      <a href="#main-rooms" class="tab-link px-4 py-2 rounded-lg font-medium text-gray-900">Saved rooms</a>
      <a href="#rooms" class="tab-link px-4 py-2 rounded-lg font-medium text-gray-900">Main rooms</a>
    </div>


    <!-- Settings Section -->
    <div id="settings" class="tab-content bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4">Settings</h2>
      <div class="space-y-4">
        <div>
          <h3 class="text-lg font-medium">Language</h3>
          <select id="language" class="w-full p-2 border rounded">
            <option value="af">Afrikaans</option>
            <option value="sq">Albanian</option>
            <option value="am">Amharic</option>
            <option value="ar">Arabic</option>
            <option value="hy">Armenian</option>
            <option value="az">Azerbaijani</option>
            <option value="eu">Basque</option>
            <option value="be">Belarusian</option>
            <option value="bn">Bengali</option>
            <option value="bs">Bosnian</option>
            <option value="bg">Bulgarian</option>
            <option value="my">Burmese</option>
            <option value="ca">Catalan</option>
            <option value="ceb">Cebuano</option>
            <option value="zh">Chinese</option>
            <option value="co">Corsican</option>
            <option value="hr">Croatian</option>
            <option value="cs">Czech</option>
            <option value="da">Danish</option>
            <option value="nl">Dutch</option>
            <option value="en">English</option>
            <option value="eo">Esperanto</option>
            <option value="et">Estonian</option>
            <option value="fi">Finnish</option>
            <option value="fr">French</option>
            <option value="fy">Frisian</option>
            <option value="gl">Galician</option>
            <option value="ka">Georgian</option>
            <option value="de">German</option>
            <option value="el">Greek</option>
            <option value="gu">Gujarati</option>
            <option value="ht">Haitian Creole</option>
            <option value="ha">Hausa</option>
            <option value="haw">Hawaiian</option>
            <option value="he">Hebrew</option>
            <option value="hi">Hindi</option>
            <option value="hmn">Hmong</option>
            <option value="hu">Hungarian</option>
            <option value="is">Icelandic</option>
            <option value="ig">Igbo</option>
            <option value="id">Indonesian</option>
            <option value="ga">Irish</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="jw">Javanese</option>
            <option value="kn">Kannada</option>
            <option value="kk">Kazakh</option>
            <option value="km">Khmer</option>
            <option value="rw">Kinyarwanda</option>
            <option value="ko">Korean</option>
            <option value="ku">Kurdish</option>
            <option value="ky">Kyrgyz</option>
            <option value="lo">Lao</option>
            <option value="la">Latin</option>
            <option value="lv">Latvian</option>
            <option value="lt">Lithuanian</option>
            <option value="lb">Luxembourgish</option>
            <option value="mk">Macedonian</option>
            <option value="mg">Malagasy</option>
            <option value="ms">Malay</option>
            <option value="ml">Malayalam</option>
            <option value="mt">Maltese</option>
            <option value="mi">Maori</option>
            <option value="mr">Marathi</option>
            <option value="mn">Mongolian</option>
            <option value="ne">Nepali</option>
            <option value="no">Norwegian</option>
            <option value="ny">Nyanja</option>
            <option value="or">Odia</option>
            <option value="ps">Pashto</option>
            <option value="fa">Persian</option>
            <option value="pl">Polish</option>
            <option value="pt">Portuguese</option>
            <option value="pa">Punjabi</option>
            <option value="ro">Romanian</option>
            <option value="ru">Russian</option>
            <option value="sm">Samoan</option>
            <option value="gd">Scots Gaelic</option>
            <option value="sr">Serbian</option>
            <option value="st">Sesotho</option>
            <option value="sn">Shona</option>
            <option value="sd">Sindhi</option>
            <option value="si">Sinhala</option>
            <option value="sk">Slovak</option>
            <option value="sl">Slovenian</option>
            <option value="so">Somali</option>
            <option value="es">Spanish</option>
            <option value="su">Sundanese</option>
            <option value="sw">Swahili</option>
            <option value="sv">Swedish</option>
            <option value="tl">Tagalog</option>
            <option value="tg">Tajik</option>
            <option value="ta">Tamil</option>
            <option value="tt">Tatar</option>
            <option value="te">Telugu</option>
            <option value="th">Thai</option>
            <option value="tr">Turkish</option>
            <option value="tk">Turkmen</option>
            <option value="uk">Ukrainian</option>
            <option value="ur">Urdu</option>
            <option value="ug">Uyghur</option>
            <option value="uz">Uzbek</option>
            <option value="vi">Vietnamese</option>
            <option value="cy">Welsh</option>
            <option value="xh">Xhosa</option>
            <option value="yi">Yiddish</option>
            <option value="yo">Yoruba</option>
            <option value="zu">Zulu</option>
          </select>
          <button id="change-language" type="submit" class="inline-block px-5 py-2 rounded-lg bg-indigo-500 text-white font-semibold shadow hover:bg-indigo-600 transition mb-4 sm:mb-0 text-center">Save</button>
          
        </div>
        <div>
          <form>
            <input type="text" placeholder="New name" class="w-full p-2 border rounded mb-4">
            <input type="submit" value="Change name" onclick="socket.emit('change name',document.querySelector('input[type=text]').value);document.querySelector('input[type=text]').value='';return false;" class="inline-block px-5 py-2 rounded-lg bg-indigo-500 text-white font-semibold shadow hover:bg-indigo-600 transition mb-4 sm:mb-0 text-center">
          </form>
        </div>
        
        <div>
          <h3 onclick="socket.emit('del account')" class="text-lg font-medium">Exit</h3>
          <p></p>
        </div>
      </div>
    </div>
    <div id="main-rooms" class="tab-content bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4">Saved rooms</h2>
      <div id="main-rooms-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- –î—Ä—É–∑—å—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
      </div>
    </div>
    <div id="rooms" class="tab-content bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4">Main rooms</h2>
      <div id="rooms-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      </div>
    </div>    
  </div>
</body>
</html>