<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Реєстрація</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="http://localhost:5050/socket.io/socket.io.js"></script>
  <script>
  const socket = io("http://localhost:5050");
    

  document.addEventListener("DOMContentLoaded", () => {
    // Проверка, есть ли уже пользователь — редирект
    fetch("/api/users")
      .then(res => res.json())
      .then(users => {
      console.log("typeof:", typeof users, "isArray:", Array.isArray(users), users);
      if (Array.isArray(users) && users.length > 0) {
        window.location.href = "/chat";
      }
      })
      .catch(err => console.error("❌ Error fetching users:", err));
  
  document.getElementById("enter-btn").addEventListener("click",()=>{
    console.log("click");
    window.location.href = "/enter";
  });
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("user-name").value.trim();
      const email = document.getElementById("user-email").value.trim();
      const password = document.getElementById("user-password").value.trim();
      const language = document.getElementById("language").value.trim();
      // Валидация имени и пароля
      if (!name || !password) return alert("❌ Заповніть всі поля");
      if (name.length > 20) return alert("Nickname cannot be more than 20 characters");
      if (password.length < 4) return alert("Password cannot be less than 4 characters");
      if (password.length > 20) return alert("Password cannot be more than 20 characters");
      if (!validateEmail(email)){
        return alert("Uncorrect email");
      }
      try {
        // Проверка на сервере
        const res = await fetch(`/api/check-user/${encodeURIComponent(name)}`);
        const data = await res.json();

        if (data.exists) {
          alert("Користувач з таким ім'ям вже існує");
          return;
        }

        // Если нет — регистрируем
        socket.emit("register", { name, password,language,email });

      } catch (err) {
        console.error("❌ Error checking user:", err);
        alert("Server error");
      }
    });

    socket.on("registerSuccess", () => window.location.href = "/chat");
    socket.on("useRegister", () => window.location.href = "/chat");
    socket.on("registerError", msg => alert("❌ " + msg));
    socket.on("redirectToChat", () => window.location.href = "/chat");
  });
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }


</script>

</head>
<body>
  <div id="register-content">
    <a  id="enter-btn" style="margin: 0;position: absolute; top:2%;background-color: #4f46e5; right:4%; color: red; font-size: 1.5em;" align="right">Enter</a>
    <div id="register-form">
      <form id="registerForm">
        <input id="user-name" type="text" placeholder="Username" required />
        <input id="user-email" type="text" placeholder="Email" required />
        <input id="user-password" type="text" placeholder="Password" required />
        
        <select id="language" class="w-full p-2 border rounded">
          <option value="af">Afrikaans</option>
          <option value="sq">Albanian</option>
          <option value="am">Amharic</option>
          <option value="ar">Arabic</option>
          <option value="hy">Armenian</option>
          <option value="az">Azerbaijani</option>
          <option value="eu">Basque</option>
          <option value="be">Belarusian</option>
          <option value="bn">Bengali</option>
          <option value="bs">Bosnian</option>
          <option value="bg">Bulgarian</option>
          <option value="my">Burmese</option>
          <option value="ca">Catalan</option>
          <option value="ceb">Cebuano</option>
          <option value="zh">Chinese</option>
          <option value="co">Corsican</option>
          <option value="hr">Croatian</option>
          <option value="cs">Czech</option>
          <option value="da">Danish</option>
          <option value="nl">Dutch</option>
          <option value="en">English</option>
          <option value="eo">Esperanto</option>
          <option value="et">Estonian</option>
          <option value="fi">Finnish</option>
          <option value="fr">French</option>
          <option value="fy">Frisian</option>
          <option value="gl">Galician</option>
          <option value="ka">Georgian</option>
          <option value="de">German</option>
          <option value="el">Greek</option>
          <option value="gu">Gujarati</option>
          <option value="ht">Haitian Creole</option>
          <option value="ha">Hausa</option>
          <option value="haw">Hawaiian</option>
          <option value="he">Hebrew</option>
          <option value="hi">Hindi</option>
          <option value="hmn">Hmong</option>
          <option value="hu">Hungarian</option>
          <option value="is">Icelandic</option>
          <option value="ig">Igbo</option>
          <option value="id">Indonesian</option>
          <option value="ga">Irish</option>
          <option value="it">Italian</option>
          <option value="ja">Japanese</option>
          <option value="jw">Javanese</option>
          <option value="kn">Kannada</option>
          <option value="kk">Kazakh</option>
          <option value="km">Khmer</option>
          <option value="rw">Kinyarwanda</option>
          <option value="ko">Korean</option>
          <option value="ku">Kurdish</option>
          <option value="ky">Kyrgyz</option>
          <option value="lo">Lao</option>
          <option value="la">Latin</option>
          <option value="lv">Latvian</option>
          <option value="lt">Lithuanian</option>
          <option value="lb">Luxembourgish</option>
          <option value="mk">Macedonian</option>
          <option value="mg">Malagasy</option>
          <option value="ms">Malay</option>
          <option value="ml">Malayalam</option>
          <option value="mt">Maltese</option>
          <option value="mi">Maori</option>
          <option value="mr">Marathi</option>
          <option value="mn">Mongolian</option>
          <option value="ne">Nepali</option>
          <option value="no">Norwegian</option>
          <option value="ny">Nyanja</option>
          <option value="or">Odia</option>
          <option value="ps">Pashto</option>
          <option value="fa">Persian</option>
          <option value="pl">Polish</option>
          <option value="pt">Portuguese</option>
          <option value="pa">Punjabi</option>
          <option value="ro">Romanian</option>
          <option value="ru">Russian</option>
          <option value="sm">Samoan</option>
          <option value="gd">Scots Gaelic</option>
          <option value="sr">Serbian</option>
          <option value="st">Sesotho</option>
          <option value="sn">Shona</option>
          <option value="sd">Sindhi</option>
          <option value="si">Sinhala</option>
          <option value="sk">Slovak</option>
          <option value="sl">Slovenian</option>
          <option value="so">Somali</option>
          <option value="es">Spanish</option>
          <option value="su">Sundanese</option>
          <option value="sw">Swahili</option>
          <option value="sv">Swedish</option>
          <option value="tl">Tagalog</option>
          <option value="tg">Tajik</option>
          <option value="ta">Tamil</option>
          <option value="tt">Tatar</option>
          <option value="te">Telugu</option>
          <option value="th">Thai</option>
          <option value="tr">Turkish</option>
          <option value="tk">Turkmen</option>
          <option value="uk">Ukrainian</option>
          <option value="ur">Urdu</option>
          <option value="ug">Uyghur</option>
          <option value="uz">Uzbek</option>
          <option value="vi">Vietnamese</option>
          <option value="cy">Welsh</option>
          <option value="xh">Xhosa</option>
          <option value="yi">Yiddish</option>
          <option value="yo">Yoruba</option>
          <option value="zu">Zulu</option>
        </select>
        <input type="submit" value="Register" />
      </form>
    </div>
  </div>
  
  <style>
    body{
      margin: 0;
    }
    #register-content {
      margin: 0;         
      background: linear-gradient(135deg, #e0e7ff, #c3dafe);
      font-family: 'Inter', sans-serif;
    }
    #register-form{
      margin: 0;
      display: flex; 
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    #registerForm {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    #registerForm:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 30px rgba(0, 0, 0, 0.15);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    input[type="submit"] {
      width: 100%;
      padding: 0.75rem;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    input[type="submit"]:hover {
      background: #4f46e5;
      transform: translateY(-2px);
    }

    input[type="submit"]:active {
      transform: translateY(0);
    }
  </style>
</body>
</html>
