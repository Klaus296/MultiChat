<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            box-sizing: border-box;
        }

        #chat-content {
            width: 100%;
            max-width: 600px;
            min-height: 400px;
            background: #ffffff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        #messageForm {
            width: 100%;
            max-width: 600px;
            display: flex;
            background: #ffffff;
            border-radius: 0 0 20px 20px;
            padding: 10px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        #messageText {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 25px;
            background: #f0f2f5;
            font-size: 16px;
            color: #333;
            outline: none;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        #messageText::placeholder { color: #999; }
        #messageText:focus { background: #e8ecef; box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.2); }

        #messageForm input[type="submit"] {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            background: #6495ed;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #messageForm input[type="submit"]:hover { background: #4682b4; transform: translateY(-2px); }
        #messageForm input[type="submit"]:active { transform: translateY(0); }

        /* Responsive design */
        @media (max-width: 768px) {
            #chat-content { max-width: 90%; min-height: 300px; padding: 15px; }
            #messageForm { max-width: 90%; padding: 10px 15px; }
            #messageText { font-size: 14px; padding: 12px; }
            #messageForm input[type="submit"] { font-size: 14px; padding: 12px 20px; }
        }

        @media (max-width: 480px) {
            #chat { padding: 10px; }
            #chat-content { max-width: 95%; min-height: 200px; padding: 10px; }
            #messageForm { max-width: 95%; padding: 8px 10px; }
            #messageText { font-size: 13px; padding: 10px; }
            #messageForm input[type="submit"] { font-size: 13px; padding: 10px 15px; }
        }
    </style>
</head>
<body bgcolor="#23B87F">
    <div id="chat">
        <a id="enter-btn" href="/chat" 
            class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300">
            Home
        </a>

        <div id="chat-content"></div>
        <form id="messageForm">
            <input id="messageText" type="text" placeholder="Enter anything...">
            <input type="submit" value="Send">
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ auth: { token: localStorage.getItem("token") } });
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
}



        let mainName = null;
        let chatNow = null;

        document.addEventListener("DOMContentLoaded", () => {
            const mainName = getCookie("username")
            const chatNow = getCookie("chat")
            console.log(mainName, chatNow)
            socket.emit("get messages",(mainName,chatNow));
            socket.emit("join chat", { mainName, chatNow });
            document.getElementById("messageForm").addEventListener("submit", (e) => {
                e.preventDefault();
                const msg = document.getElementById("messageText").value.trim();
                if (!msg || !chatNow || !mainName) return;

                socket.emit("set chat", { chatNow, mainName, msg });
                document.getElementById("messageText").value = "";
            });
        });

        

        // socket.on("no friend", () => {
        //     alert("No friend selected for chat.");
        //     window.location.href = "/";
        // });

        // Обновление чата
        socket.on("chat set", (data) => {
            const chatContent = document.getElementById("chat-content");
            chatContent.innerHTML = ""
            if (!data.messages || !Array.isArray(data.messages)) return;

            data.messages.forEach((msg, index) => {
                const name = msg.username || msg.sender || "Unknown";
                const text = msg.text || "";
                if (name === "Unknown") return;

                const div = document.createElement("div");
                div.innerHTML = `<p><strong>${name}</strong>: <span>${escapeHtml(text)}</span></p>`;
                div.style = "font-size:1.5em; color:#2F5C4B; margin-bottom: 10px;";

                // Контейнер кнопок
                const btnContainer = document.createElement("div");
                btnContainer.style.display = "none";
                btnContainer.style.marginTop = "5px";
                btnContainer.style.gap = "10px";

                // Delete button
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Delete";
                deleteBtn.style.background = "#ff4444";
                deleteBtn.style.color = "white";
                deleteBtn.style.padding = "5px 10px";
                deleteBtn.style.border = "none";
                deleteBtn.style.borderRadius = "3px";
                deleteBtn.style.cursor = "pointer";
                deleteBtn.addEventListener("click", () => {
                    if (mainName && chatNow) {
                        socket.emit("delete message", { id: msg.id, mainName, chatNow });
                    }
                    btnContainer.style.display = "none";
                });

                // Complain button
                const complainBtn = document.createElement("button");
                complainBtn.textContent = "Complain";
                complainBtn.style.background = "#33b5e5";
                complainBtn.style.color = "white";
                complainBtn.style.padding = "5px 10px";
                complainBtn.style.border = "none";
                complainBtn.style.borderRadius = "3px";
                complainBtn.style.cursor = "pointer";
                complainBtn.addEventListener("click", () => {
                    alert("Жалоба отправлена на сообщение: " + text);
                    btnContainer.style.display = "none";
                });

                btnContainer.appendChild(deleteBtn);
                btnContainer.appendChild(complainBtn);
                div.appendChild(btnContainer);

                div.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    btnContainer.style.display = "block";
                });

                let touchTimer = null;
                div.addEventListener("touchstart", (e) => {
                    touchTimer = setTimeout(() => { btnContainer.style.display = "block"; }, 500);
                });
                div.addEventListener("touchend", () => clearTimeout(touchTimer));

                document.addEventListener("click", (e) => {
                    if (!div.contains(e.target)) btnContainer.style.display = "none";
                });

                chatContent.appendChild(div);
            });

            chatContent.scrollTop = chatContent.scrollHeight;
        });

        // XSS защита
        function escapeHtml(str) {
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        socket.on("chat error", (data) => alert(data));
    </script>
</body>
</html>
