<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="friends" class="tab-content bg-white rounded-2xl shadow-xl p-6 mb-6">
      <a href="/chat" class="inline-block px-5 py-2 rounded-lg bg-indigo-500 text-white font-semibold shadow hover:bg-indigo-600 transition mb-4 sm:mb-0 text-center">
        Home
      </a>
      <h2 class="text-xl sm:text-2xl font-semibold mb-4">Friends</h2>
      <div id="friends-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Друзья будут добавляться сюда -->
      </div>
    </div>
    
    <script>
        const socket = io();
        document.addEventListener("DOMContentLoaded", () => {
            // запрос имени
            socket.emit("get user name")
            socket.emit("show friends"); 
            socket.emit("show chats");
            socket.emit("show rooms");
            
            socket.on("username",(username)=>{
                const name = username;
                if (!name){
                window.location.href="/";
                return;
                }
            })

            socket.on("chatsList", (userFriends) => {
                const friendsContainer = document.querySelector("#friends-list");
                friendsContainer.innerHTML = "";
                socket.on("createRoomSuccess", (newRoom) => {
                console.log("New Room");
                });
                if (!userFriends || userFriends.length === 0) {
                friendsContainer.innerHTML = `<p class="text-gray-500">No friends found</p>`;
                return;
                }
                userFriends.forEach(friendName => {
                const friendCard = document.createElement("div");
                friendCard.className =
                    "flex items-center gap-3 p-4 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition";
                friendCard.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">
                    ${friendName[0].toUpperCase()}
                    </div>
                    <span class="font-medium">${friendName}</span>
                `;
                friendCard.onclick = () => toChat(friendName);
                friendsContainer.appendChild(friendCard);
                });
            });
            // слушаем список отправителей
            socket.on("chatList", (senders) => {
                console.log("Список отправителей:", senders); // для отладки
                const chatList = document.getElementById("friends-list");
               

                senders.forEach(sender => {
                    const li = document.createElement("div");
                    li.className="flex items-center gap-3 p-4 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition";
                    li.innerHTML = `<div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">${sender[0].toUpperCase()}</div><span class="font-medium">${sender}</span>`
                    
                    // можно повесить клик, чтобы открыть чат с этим пользователем
                    li.onclick = () => toChat(sender);

                    chatList.appendChild(li);
                });
            });

            function toChat(friend){
                socket.emit("get hash",friend);
                socket.on("set hash",(hash)=>{
                console.log(hash);    
                window.location.href = `/your?room=${encodeURIComponent(hash)}`;          
            })
                
            }
        });
                    
    </script>
</body>
</html>