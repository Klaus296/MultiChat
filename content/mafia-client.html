<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞—Ñ—ñ—è ‚Äî –≥—Ä–∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-4xl bg-gray-800/60 rounded-2xl shadow-2xl p-6">
    <div id="lobbyScreen">
      <h1 class="text-3xl font-bold mb-4">üé≠ –ú–∞—Ñ—ñ—è ‚Äî –ª–æ–±—ñ</h1>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block mb-2">–í–∞—à –Ω—ñ–∫</label>
          <input id="nick" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Stas" />
        </div>
        <div>
          <label class="block mb-2">–ö–Ω–æ–ø–∫–∞</label>
          <div class="flex gap-2">
            <button id="joinBtn" class="px-4 py-2 rounded bg-green-500 hover:bg-green-600">–ó–∞–π—Ç–∏ –≤ –ª–æ–±—ñ</button>
            <button id="leaveBtn" class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 hidden">–í–∏–π—Ç–∏</button>
          </div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-3 gap-4">
        <div class="bg-gray-700 p-4 rounded">
          <div class="text-sm text-gray-300">–ì—Ä–∞–≤—Ü—ñ–≤ –≤ –ª–æ–±—ñ</div>
          <div id="lobbyCount" class="text-2xl font-bold mt-2">0</div>
        </div>
        <div class="bg-gray-700 p-4 rounded">
          <div class="text-sm text-gray-300">–û—Å—Ç–∞–Ω–Ω—ñ —Å–∏—Å—Ç–µ–º–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>
          <div id="sysMsgs" class="mt-2 text-sm h-20 overflow-auto"></div>
        </div>
        <div class="bg-gray-700 p-4 rounded">
          <div class="text-sm text-gray-300">–¢—É—Ç –∑'—è–≤–∏—Ç—å—Å—è –≤–∞—à–∞ –∫—ñ–º–Ω–∞—Ç–∞</div>
          <div id="roomInfo" class="mt-2 text-sm"></div>
        </div>
      </div>
    </div>

    <div id="gameScreen" class="hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">–ì—Ä–∞: <span id="roomName"></span></h2>
        <div>
          <span class="text-sm text-gray-400">–í–∞—à–∞ —Ä–æ–ª—å: </span><strong id="myRole">‚Äî</strong>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-3 gap-4">
        <div class="col-span-2 bg-gray-800 p-4 rounded">
          <div id="phaseBanner" class="mb-3 p-3 rounded text-center bg-gray-700">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>

          <div id="playersList" class="grid grid-cols-2 gap-2"></div>

          <div id="actionsArea" class="mt-4"></div>
        </div>

        <div class="bg-gray-800 p-4 rounded">
          <div class="text-sm text-gray-300">–õ–æ–≥–∏</div>
          <div id="log" class="mt-2 h-48 overflow-auto text-sm"></div>
        </div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="leaveGame" class="px-4 py-2 rounded bg-red-600">–í–∏–π—Ç–∏ –∑ –≥—Ä–∏</button>
      </div>
    </div>
  </div>

<script>
  const socket = io();

  // UI –µ–ª–µ–º–µ–Ω—Ç–∏
  const nickInp = document.getElementById('nick');
  const joinBtn = document.getElementById('joinBtn');
  const leaveBtn = document.getElementById('leaveBtn');
  const lobbyCount = document.getElementById('lobbyCount');
  const sysMsgs = document.getElementById('sysMsgs');
  const roomInfo = document.getElementById('roomInfo');

  const lobbyScreen = document.getElementById('lobbyScreen');
  const gameScreen = document.getElementById('gameScreen');
  const roomNameEl = document.getElementById('roomName');
  const myRoleEl = document.getElementById('myRole');
  const phaseBanner = document.getElementById('phaseBanner');
  const playersList = document.getElementById('playersList');
  const log = document.getElementById('log');
  const actionsArea = document.getElementById('actionsArea');

  let myNick = null;
  let myRoom = null;
  let myRole = null;
  let players = [];

  function addLog(text) {
    const p = document.createElement('div'); p.textContent = text;
    log.prepend(p);
  }

  joinBtn.onclick = () => {
    const name = nickInp.value.trim();
    if (!name) return alert('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫');
    myNick = name;
    socket.emit('mafia_join_lobby', { username: name });
    joinBtn.classList.add('hidden');
    leaveBtn.classList.remove('hidden');
    addLog('–í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è –≤ –ª–æ–±—ñ —è–∫ ' + name);
  };

  leaveBtn.onclick = () => {
    socket.emit('mafia_leave_lobby', { username: myNick });
    myNick = null;
    joinBtn.classList.remove('hidden');
    leaveBtn.classList.add('hidden');
    addLog('–í–∏ –≤–∏–π—à–ª–∏ –∑ –ª–æ–±—ñ');
  };

  // –ü–æ–¥—ñ—ó –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
  socket.on('mafia_joined_lobby', (data) => {
    addSys('–í–∞—Å –¥–æ–¥–∞–Ω–æ –¥–æ –ª–æ–±—ñ (–ø–æ–∑–∏—Ü—ñ—è: ' + data.position + ')');
  });

  socket.on('mafia_lobby_count', (d) => {
    lobbyCount.textContent = d.count;
  });

  socket.on('mafia_room_assigned', (data) => {
    // –û—Ç—Ä–∏–º–∞–ª–∏ –∫—ñ–º–Ω–∞—Ç—É
    myRoom = data.room;
    players = data.players.map(p => ({ user: p.user, alive: true }));
    showGameScreen();
    addLog('–í–∞—Å –ø–µ—Ä–µ—Å–∞–¥–∏–ª–∏ –≤ –∫—ñ–º–Ω–∞—Ç—É ' + myRoom);
  });

  socket.on('mafia_your_role', (d) => {
    myRole = d.role;
    myRoleEl.textContent = myRole;
    addLog('–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å: ' + myRole);
  });

  socket.on('mafia_roles_assigned', (d) => {
    addLog('–†–æ–ª—ñ —Ä–æ–∑–¥–∞–Ω—ñ. –£ –≥—Ä—ñ ' + d.publicCount + ' –≥—Ä–∞–≤—Ü—ñ–≤.');
  });

  socket.on('mafia_game_started', () => {
    addLog('–ì—Ä–∞ —Å—Ç–∞—Ä—Ç—É–≤–∞–ª–∞!');
  });

  socket.on('mafia_phase', (d) => {
    phaseBanner.textContent = '–§–∞–∑–∞: ' + d.phase.toUpperCase() + (d.duration ? ' ‚Äî ' + Math.round(d.duration/1000)+'s' : '');
    addLog('–§–∞–∑–∞: ' + d.phase);
    renderActions(d.phase);
  });

  socket.on('mafia_night_result', (d) => {
    if (d.killed) addLog('–ù—ñ—á: —É–±–∏—Ç–∏–π ' + d.killed);
    else addLog('–ù—ñ—á: –Ω—ñ—Ö—Ç–æ –Ω–µ –∑–∞–≥–∏–Ω—É–≤');
    if (d.checks && d.checks.length) {
      d.checks.forEach(c => {
        if (c.checker === myNick) addLog('–í–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–ª–∏ ' + c.target + ' ‚Äî —Ä–æ–ª—å: ' + c.targetRole);
      });
    }
    renderPlayers();
  });

  socket.on('mafia_vote_start', (d) => {
    addLog('–ü–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è ('+Math.round(d.voteMs/1000)+'s). –û–±–∏—Ä–∞–π—Ç–µ –∫–æ–≥–æ –≤–±–∏—Ç–∏.');
    renderVoteButtons();
  });

  socket.on('mafia_votes_update', (d) => {
    addLog('–û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–æ–ª–æ—Å—ñ–≤: ' + JSON.stringify(d.votes));
  });

  socket.on('mafia_lynch_result', (d) => {
    if (d.victim) addLog('–î–µ–Ω—å: –ø–æ–≤—ñ—à–µ–Ω–æ ' + d.victim);
    else addLog('–î–µ–Ω—å: –Ω—ñ–∫–æ–≥–æ –Ω–µ –ø–æ–≤—ñ—Å–∏–ª–∏');
    renderPlayers();
  });

  socket.on('mafia_game_over', (d) => {
    addLog('–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–º–æ–∂–µ—Ü—å: ' + d.winner);
    phaseBanner.textContent = '–ì–†–ê –ó–ê–í–ï–†–®–ï–ù–ê ‚Äî ' + d.winner.toUpperCase();
    actionsArea.innerHTML = '';
  });

  // UI: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—ñ–≤
  function showGameScreen() {
    lobbyScreen.classList.add('hidden');
    gameScreen.classList.remove('hidden');
    roomNameEl.textContent = myRoom;
    renderPlayers();
  }
  function showLobby() {
    lobbyScreen.classList.remove('hidden');
    gameScreen.classList.add('hidden');
  }

  function renderPlayers() {
    playersList.innerHTML = '';
    players.forEach(p => {
      const el = document.createElement('div');
      el.className = 'p-2 bg-gray-700 rounded flex items-center justify-between';
      el.innerHTML = `<div>${p.user}</div><div>${p.alive ? 'üü¢' : '‚ö´'}</div>`;
      playersList.appendChild(el);
    });
  }

  function renderActions(phase) {
    actionsArea.innerHTML = '';
    if (phase === 'night') {
      if (!myRole) return;
      if (myRole === 'mafia') {
        actionsArea.innerHTML = '<div class="text-sm mb-2">–í–∏ –º–∞—Ñ—ñ—è ‚Äî –æ–±–µ—Ä—ñ—Ç—å —Ü—ñ–ª—å –Ω–∞ –≤–±–∏–≤—Å—Ç–≤–æ:</div>';
        renderTargetButtons('kill');
      } else if (myRole === 'doctor') {
        actionsArea.innerHTML = '<div class="text-sm mb-2">–í–∏ –ª—ñ–∫–∞—Ä ‚Äî –æ–±–µ—Ä—ñ—Ç—å –∫–æ–≥–æ –ª—ñ–∫—É–≤–∞—Ç–∏:</div>';
        renderTargetButtons('heal');
      } else if (myRole === 'detective') {
        actionsArea.innerHTML = '<div class="text-sm mb-2">–í–∏ –¥–µ—Ç–µ–∫—Ç–∏–≤ ‚Äî –æ–±–µ—Ä—ñ—Ç—å –∫–æ–≥–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:</div>';
        renderTargetButtons('check');
      } else {
        actionsArea.innerHTML = '<div class="text-sm">–í–∏ –º–∏—Ä–Ω–∏–π ‚Äî —á–µ–∫–∞–π—Ç–µ –Ω–æ—á—ñ...</div>';
      }
    } else if (phase === 'day') {
      actionsArea.innerHTML = '<div class="text-sm">–î–µ–Ω—å ‚Äî –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è. –ü–æ—Ç—ñ–º –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è.</div>';
    } else {
      actionsArea.innerHTML = '';
    }
  }

  function renderTargetButtons(actionType) {
    const cont = document.createElement('div');
    cont.className = 'grid grid-cols-2 gap-2 mt-2';
    players.forEach(p => {
      if (!p.alive) return;
      const btn = document.createElement('button');
      btn.className = 'p-2 rounded bg-blue-600 hover:bg-blue-500 text-sm';
      btn.textContent = p.user;
      btn.onclick = () => {
        socket.emit('mafia_night_action', { room: myRoom, username: myNick, type: actionType, target: p.user });
        addLog('–í–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ –Ω—ñ—á–Ω—É –¥—ñ—é: ' + actionType + ' ‚Üí ' + p.user);
      };
      cont.appendChild(btn);
    });
    actionsArea.appendChild(cont);
  }

  function renderVoteButtons() {
    actionsArea.innerHTML = '<div class="text-sm mb-2">–ì–æ–ª–æ—Å—É–π—Ç–µ –ø—Ä–æ—Ç–∏:</div>';
    const cont = document.createElement('div');
    cont.className = 'grid grid-cols-2 gap-2 mt-2';
    players.forEach(p => {
      if (!p.alive) return;
      const btn = document.createElement('button');
      btn.className = 'p-2 rounded bg-yellow-600 hover:bg-yellow-500 text-sm';
      btn.textContent = p.user;
      btn.onclick = () => {
        socket.emit('mafia_vote', { room: myRoom, username: myNick, target: p.user });
        addLog('–í–∏ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–∏ –ø—Ä–æ—Ç–∏: ' + p.user);
      };
      cont.appendChild(btn);
    });
    actionsArea.appendChild(cont);
  }

  // leave game
  document.getElementById('leaveGame').onclick = () => {
    if (myRoom) {
      socket.emit('mafia_leave_lobby', { username: myNick });
      addLog('–í–∏ –∑–∞–ª–∏—à–∏–ª–∏ –≥—Ä—É');
      myRoom = null;
      myRole = null;
      players = [];
      showLobby();
    }
  };

  // –°–∏—Å—Ç–µ–º–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  function addSys(txt) {
    const d = document.createElement('div'); d.textContent = txt;
    sysMsgs.prepend(d);
  }

  // –ü—Ä–∏–∫–ª–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –≥—Ä–∞–≤—Ü—ñ–≤ (—Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏)
  socket.on('mafia_player_list', (data) => {
    players = data.players;
    renderPlayers();
  });

</script>
</body>
</html>
